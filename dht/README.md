# DHT

Каждый сервер одновременно:
1. Oбслуживает клиентские запросы [OpenAPI спека](api/api.yaml)
2. Является нодой в Bittorrent DHT
3. Является пиром для скачивания сообщений

Для реализации DHT используется библотека [anacrolix/dht](https://github.com/anacrolix/dht).

При получении запроса [put](api/api.yaml#L7) сервер:

1. Сохраняет ключ и значение локально ([код](api/api.go#L71))
2. Анонсирует для всего графа доступных нод (сначала известные ноды, затем ноды
   известные им и т.д) свой адрес как пир для полученного ключа ([код](api/api.go#L79))

При получении запроса [getMany](api/api.yaml#L29) сервер:

1. Вычитывает из локального хранилища все значения, ключи которых подходят под фильтр ([код](api/api.go#L104))
2. Скачивает все известные значения с подходящими ключами из пиров и сохраняет их локально ([код](api/api.go#L112))

При добавлении нового сервера нужен только адрес одной ноды ([код](main.go#L40)). Затем новая нода
проходит процедуру бустрапа, запрашивая у стартовой ноды все известные адреса,
пополняя локальную таблицу ([код](main.go#L58)). 

Все серверы периодически анонсируют свои ключи
всем участникам, чтобы о них узнали новые/перезагрузивниеся/временно недоступные
ноды ([код](main.go#L65)).

Все участники периодически скачивают значения, которых не имеют локально, из
других и сами становятся для них пирами ([код](main.go#L76)). Таким образом,
значение, которое положили в DHT, со временем будет храниться на всех нодах.





